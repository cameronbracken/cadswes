%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% AGUtmpl.tex: this template file is for articles formatted with LaTeX2e,
% Modified March 2009
%
% This template includes commands and instructions
% given in the order necessary to produce a final output that will
% satisfy AGU requirements.
%
% PLEASE DO NOT USE YOUR OWN MACROS
%
% For more information on using the AGUTeX macro package,
% see agudocs.tex or agudocs.pdf
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% All questions should be e-mailed to author.help@agu.org.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Step 1: set the \documentclass
%
% The three options for article format are: two-column (default),
% draft, for initial article submission; and galley for narrow
% single columns.
%
% PLEASE USE THE DRAFT OPTION TO SUBMIT YOUR PAPERS
% The draft option produces double spaced output
%
% Choose the journal abbreviation for the journal you are
% submitting to:

% jgrga JOURNAL OF GEOPHYSICAL RESEARCH
% gbc   GLOBAL BIOCHEMICAL CYCLES
% grl   GEOPHYSICAL RESEARCH LETTERS
% pal   PALEOCEANOGRAPHY
% ras   RADIO SCIENCE
% rog   REVIEWS OF GEOPHYSICS
% tec   TECTONICS
% wrr   WATER RESOURCES RESEARCH
% gc    GEOCHEMISTRY, GEOPHYSICS, GEOSYSTEMS

% (If you are submitting to a journal other than jgrga,
% substitute the initials of the journal for "jgrga" below)

\documentclass[wrr]{AGUTeX}
 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% optional article formats author might want to use

% To produce a galley version:
% \documentclass[galley,jgrga]{AGUTeX}

% To produce a two columned version:
% \documentclass[jgrga]{AGUTeX}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% OPTIONAL:
% To print your article using PostScript fonts, uncomment this:
% \usepackage{agu-ps}
% You many need to edit the top of agu-ps to use the names of the PS
% fonts on your system.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% OPTIONAL:
% To Create numbered lines:

% If you don't already have lineno.sty, you can download it from
% http://www.ctan.org/tex-archive/macros/latex/contrib/ednotes/
% (or google lineno.sty ctan), available at TeX Archive Network (CTAN).
% Take care that you always use the latest version.

% To activate the commands, uncomment \usepackage{lineno}
% and \linenumbers*[1]command, below:

% \usepackage{lineno}
% \linenumbers*[1]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Figures and Tables
%

% When submitting articles through the GEMS system:
% COMMENT OUT ANY COMMANDS THAT INCLUDE GRAPHICS.
% (See FIGURES section near the end of the file)


%  Figures and Tables should be placed at the end of the article,
%  after the references.
%
%  Uncomment the following command to include .eps files
%  (comment out this line for draft format):
  \usepackage[pdftex]{graphicx}
%
%    Uncomment the following command to allow illustrations to print
%    when using Draft:
  \setkeys{Gin}{draft=false}
%
% Substitute one of the following for [dvips] above
% if you are using a different driver program and want to
% proof your illustrations on your machine:
%
% [xdvi], [dvipdf], [dvipsone], [dviwindo], [emtex], [dviwin],
% [pctexps],  [pctexwin],  [pctexhp],  [pctex32], [truetex], [tcidvi],
% [oztex], [textures]
%
% See how to enter figures and tables at the end of the article, after
% references.
%
%% ------------------------------------------------------------------------ %%
%
%  ENTER PREAMBLE
%
%% ------------------------------------------------------------------------ %%

% Author names in capital letters:
\authorrunninghead{BRACKEN ET AL.}

% Shorter version of title entered in capital letters:
\titlerunninghead{HM MODEL FOR STREAMFLOW IN THE UPPER COLORADO RIVER BASIN}

% Author mailing address: please repeat this command for
% each author and alphabetize authors:

%\authoraddr{R. C. Bales,
%Department of Hydrology and Water Resources, University of
%Arizona, Harshbarger Building 11, Tucson, AZ 85721, USA.
%(roger@hwr.arizona.edu)}

%\authoraddr{J. R. McConnell, Division of Hydrologic
%Sciences, 123 Main Street, Desert Research Institute, Reno, NV
%89512, USA.}

%\authoraddr{E. Mosley-Thompson, Department of Geography,
%Ohio State University, 123 Orange Boulevard, Columbus, OH 43210,
%USA.}

%\authoraddr{R. Williams, Department of Space Sciences, University of
%Michigan, 123 Brown Avenue, Ann Arbor, MI 48109, USA.}

\usepackage{amsmath,amssymb}
\usepackage{booktabs}
%\usepackage{tikz}
%\usetikzlibrary{external}
%\tikzexternalize[prefix=plots/]
%\graphicspath{{plots/}}
\usepackage{url}

% Put placeholders for equations, for conversion to word
%\let\oldequation\equation
%\let\oldendequation\endequation
%\renewenvironment{equation}
%  {\setbox0=\vbox\bgroup\oldequation}
%  {\oldendequation\egroup\[\hbox{[Equation \theequation\ here]}\]}

\begin{document}

%% ------------------------------------------------------------------------ %%
%
%  TITLE
%
%% ------------------------------------------------------------------------ %%


\title{A Nonstationary Hidden Markov Model for Stochastic Streamflow Simulation and Short Term Forecasting in the Upper Colorado River Basin}
%
% e.g., \title{Terrestrial ring current:
% Origin, formation, and decay $\alpha\beta\Gamma\Delta$}
% You may use \\ to break the title over several lines.

%% ------------------------------------------------------------------------ %%
%
%  AUTHORS AND AFFILIATIONS
%
%% ------------------------------------------------------------------------ %%

\authors{C. Bracken, \altaffilmark{1}
B. Rajagopalan, \altaffilmark{1,2} E. Zagona \altaffilmark{1}}

\altaffiltext{1}{Department of Civil, Environmental and Architectural 
Engineering, University of Colorado at Boulder}
\altaffiltext{2}{Cooperative Institute for Research in Environmental Sciences (CIRES)}

%Use \author{\altaffilmark{}} and \altaffiltext{}

% \altaffilmark will produce footnote;
% matching altaffiltext will appear at bottom of page.
% May use \\ to start a new line.

%\authors{R. C. Bales, \altaffilmark{1}
%E. Mosley-Thompson, \altaffilmark{2} R. Williams, \altaffilmark{3}
%and J. R. McConnell\altaffilmark{4}}

%\altaffiltext{1}{Department of Hydrology and Water Resources,
%University of Arizona, Tucson, Arizona, USA.}

%\altaffiltext{2}{Department of Geography, Ohio State University,
%Columbus, Ohio, USA.}

%\altaffiltext{3}{Department of Space Sciences, University of
%Michigan, Ann Arbor, Michigan, USA.}

%\altaffiltext{4}{Division of Hydrologic Sciences, Desert Research
%Institute, Reno, Nevada, USA.}

%% ------------------------------------------------------------------------ %%
%
%  ABSTRACT
%
%% ------------------------------------------------------------------------ %%

% >> Do NOT include any \begin...\end commands within
% >> the body of the abstract.

\begin{abstract}
Upper Colorado River Basin annual flow exhibits very low autocorrelation but regime shifting behavior causing long departures from the historical average flow producing sustained wet and dry periods. Traditional stochastic time series models do not capture this feature thereby misleading the water resources system risk and consequently impacting the management and planning efforts. To address this, we developed a nonstationary Hidden Markov (HM) model with Gamma component distributions, as opposed to Normal distributions which is widely used in literature, for stochastic simulation and short term forecasting. Global decoding from this model reveals and captures strong underlying persistent structure in the Lees Ferry flow time series. In addition to capturing the shifting mean, simulations from this model have a 20\% greater chance than a first order Auto Regressive model (AR1), the best time series model for this data, of simulating wet and dry runs of 6 or more years. Relative to AR1 the HM model also captures the spectral features quite well. When applied to short term forecasting (i.e. of 1-2 years) they show higher skill relative to climatology but also to an AR1 model. 
\end{abstract}

%% ------------------------------------------------------------------------ %%
%
%  BEGIN ARTICLE
%
%% ------------------------------------------------------------------------ %%

% The body of the article must start with a \begin{article} command
%
% \end{article} must follow the references section, before the figures
%  and tables.
%\pagestyle{empty}
%\raggedright
\begin{article}

%% ------------------------------------------------------------------------ %%
%
%  TEXT
%
%% ------------------------------------------------------------------------ %%

\section{Introduction}

The past decade has been one of unprecedented drought in the Upper Colorado River Basin (UCRB) (\url{www.usbr.gov/uc/feature/drought.html}). Traditional time series methods for simulating and forecasting \citep{Salas1980} annual flow at Less Ferry, the outlet of the UCRB, generates such drought with extremely small probability, leading to an underestimation of water resources system risk. This problem with traditional time series methods applied to the annual natural flow data at Lees Ferry is due to an interesting dilemma that it presents -- in that the data exhibits distinct regime-like behavior with long departures from the mean annual flow though still maintains a very weak autocorrelation structure (lag 1 is barely significant)  (Figure \ref{fig:lfts}). Traditional time series models are based on autocorrelation structure, thus, a weak autocorrelation leads to weak persistence and lower probability of long wet and dry spells.  These long departures from the mean are important for multi-year reservoir planning in the UCRB since they stress the system far more than single wet or dry years.  This behavior is similar to that suggested by \cite{Akntug:2005wx} where persistence structure in the data (in terms of climate regimes) is not fully described by the autocorrelation function. 

Links between large scale climate drivers and UCRB hydrology are increasingly apparent \citep{Timlsena:2009it,McCabe:2007vh,Hunter:2006fa,Grantz:2005ve,Hidalgo:2003ue,Piechota:1996dd,Nash:1991ty}.  These links are thought to create the type of long period regime switching behavior observed in the data.  Though as the literature indicates, this links are not necessarily strait forward, especially at the annual level or aggregated over the entire basin.  

Many models have been proposed for annual flow time series that have applications to both simulation and forecasting.  Most basic is the lag 1 autoregressive model (AR1) \citep{Salas1980} within the general autoregressive moving average (ARMA) framework.  In fact, this is the model which the AIC criterion suggests as the best for the Lees Ferry data.  These models have a number of drawbacks including the assumption of normality and stationarity.  This is typically corrected for by transformation but does not guarantee that statistics will be preserved after transformation.  AR models are also known to poorly reproduce the spectral properties of time series [\cite{Kwon:2007fj}; Nowak et al., 2011]. 

Another commonly used methods for simulation in the UCRB is the index sequential method (ISM) \citep{Ouarda:1997wz}.  This method is one used by the Bureau of Reclamation to produce flow sequences for the Colorado River Simulation System (CRSS) \citep{BureauofReclamation:1987tk}. The ISM can directly reproduce observed statistics but (1) it does not maintain the integrity of a complete data sequence, (2) it cannot simulate unobserved values (3) nor can it be used for forecasting (since a forecast would simply be climatology).  Improvements to this have been proposed in the K-nearest neighbor resampling framework \citep{Lall:1996ur,Prairie:2008ei}. These capture the distributional properties much better but suffer from their inability to capture the spectral and persistence properties (i.e., long excursions of wet and dry spells) that are important for management. 

Spectral methods such as fourier analysis \cite{Salas1980} and wavelet autoregressive methods (WARM) \cite[and references therein]{Kwon:2007fj} improve upon traditional methods by capturing the observed spectrum.   These methods involve breaking a timeseries down into orthogonal components, modeling each component separately and adding the components back together. WARM can reproduce spectral features in a data and can capture a prescribed nonstationarity (Nowak et al., 2011). 

Some time series models can explicitly capture regime switching behavior without decomposition. The Shifting Level (SL) proposed by \cite{Boes:1978ff} is one such example.  \cite{Fortin:2004gz}   provides an overview of other similar models. \cite{Salas:1980im} describe the case of the Nile River Basin where the shifting means can produce spurious autocorrelation.   In fact the Lees Ferry data exhibits somewhat similar behavior, the serial correlation from 1906-1981 is 0.11 and from 1982--2010 it is 0.48 while for the whole period it is 0.26.  This is indicative of a regime switching behavior in terms of autocorrelation but the behavior is also apparent in the mean.  The original SL model did not estimate the nonstationary mean and was therefore not useful for forecasting.  A reformulated SL model was described by \cite{Fortin:2004gz} and shown to be a special case of a class of models known as Hidden Markov models. 


Hidden Markov (HM) models (also know as Markov switching models or dependent mixture models) have wide applicability in hydrology for both simulation and forecasting though most of the applications have been to rainfall data \citep{Jackson:1975gn,Zucchini:1991tk,Thyer:2000ud,Mehrotra:2005ts}.  In applications to streamflow, HM models have been \citep{Zucchini:1991tk,Akntug:2005wx,Gelati:2010wk} are attractive because of their ability to simulate long persistence and regime switching behavior in hydrologic time series.  Regime changes, especially on the annual scale have been attributed to regime shifts driven by large scale in the climate features.  The above applicaitions to annual flow have focussed on data with strong autocorrelation.

\cite{Akntug:2005wx} discuss the correspondence of HM models with AR.  Though different in structure, they suggest that an HM($m$) model has a similar autocorrelation structure to an order $\mbox{AR(m+1)}$.  This result is indeed important for datasets that exhibit
significant autocorrelation at high lags but leaves open the question of data with very weak autocorrelation such as Lees Ferry.  \cite{Akntug:2005wx} also use a homogeneous stationary hidden Markov model to simulate annual runoff for the Niagara River. The Niagara River exhibits strong autocorrelation and so is ideal to be simulated with HM models or higher order ARMA models.  As mentioned previously this is a very different problem than in the UCRB. \cite{Gelati:2010wk} use a stationary nonhomogeneous HM model conditioned on ENSO indices. They make single step quarterly forecasts and longer term simulations of runoff. Given this extensive literature, we believe that HM model would be a suitable approach for UCRB annual flow, this motivates the present research. The goal of this paper is to develop a nonstationary Hidden Markov (HM) model with Gamma component distributions for simulation and forecasting annual flow in the UCRB. In particular we are interested in the ability of HM models to capture regime switching behavior but maintain low autocorrelation.

The paper is structured as follows. A brief overview of the model formulation, parameter estimation is given and moments of a Gamma HM model are derived. The application of HM models to Lees's Ferry Natural flow data is described for both simulation and short forecasting.  Results of the simulation and forecasting procedures are then presented followed by the conclusions of this study.

\section{Methodology}
\subsection{Model Formulation}
As mentioned above, Hidden Markov (HM) models are also know as Markov switching models, Markov mixture models or  dependent mixture models.  An order $m$ HM model transitions or switches between $m$ `hidden` states according to a discrete Markov chain with transition probability matrix $\boldsymbol\Gamma$.  These states are typically described as climate regimes \citep{Thyer:2000ud,Akntug:2005wx,Gelati:2010wk}.  Each state prescribes a probability distribution know as a component distribution.  The parameters of the component distributions are dependent on the state of the Markov process.  We avoid using the terms ``wet'' and ``dry'' to describe the states of two state model as this can be slightly misleading since low flow can be generated in the ``wet'' state and visa-versa.  We assume that the component distributions follow gamma distributions, i.e.

The notation for HM models in the literature is somewhat unstandardized; we will adopt the notation of \cite{Zucchini:2009vl}. For an observed sequence $X_t$, $t=1,2,...,T$,  the general form of a HM model is

\begin{equation}
\mbox{Pr}(C_t|\mathbf{C}^{(t-1)})=\mbox{Pr}(C_t|C_{t-1}), t=2,3,...,T
\end{equation}
\begin{equation}
\mbox{Pr}(X_t|\mathbf{X}^{(t-1)},\mathbf{C}^{(t)})=\mbox{Pr}(X_t|C_{t}), t\in\mathbb{N}
\end{equation}

Where $C_t$ is the unobserved or ``hidden'' sequence that follows a simple first order Markov process. $\mathbf{C}_t$ denotes the sequence $C_1, C_2, ..., C_T$.  The transition probabilities, i.e. the conditional probabilities of transition from one hidden state to another are defined as
\begin{equation}
\gamma_{jk} = \mbox{Pr}( C_{i+1} = k | C_i = j )
\end{equation}
Or in matrix form
\begin{equation}
\boldsymbol\Gamma = 
\left[
\begin{array}{ccc}
\gamma_{11} & \cdots & \gamma_{1m}\\
\vdots & \ddots & \vdots\\
\gamma_{m1} & \cdots & \gamma_{mm}\\
\end{array}
\right]
\end{equation}
In this formulation, the observed sequence $X_t$ is dependent only on the current hidden state $C_t$. Note that in general $X_t$ is not a Markov process \citep{Zucchini:2009vl}.  

The hidden sequence $C_t$ determines the state dependent probability distribution 
\begin{equation}
p_i(x)=\mbox{Pr}(X_t = x | C_t =i)
\end{equation}
For our purposes $p_i$ will represent a probability density function but it may similarly represent a probability mass function in the discrete case.  In the literature, Gaussian component distributions have been commonly used either directly or after transforming the data \citep{Jackson:1975gn,Thyer:2000ud,Akntug:2005wx,Gelati:2010wk}.  The Gamma distribution is commonly used in the hydrologic modeling because of it lower bound of zero \cite{Salas1980}. Here investigate the use of a Gamma component distribution.  In the case of a Gamma component distribution
\begin{equation}
p_i(x) = g(x;k_i,\beta_i) = \frac{\beta_i^{k_i}}{\Gamma(k_i)} x^{k_i-1} e^{-\beta_i {x}} \text{ for }x \geq 0.
\end{equation}
Where $k_i$ is the state dependent shape parameter, $\beta_i$ is the state dependent rate parameter and $\Gamma$ is the gamma function. The result is analogous for normal component distributions. 

We use a nonstationary version of the model described by \cite{Akntug:2005wx}.  Our model does not assume that the initial distribution is the stationary distribution and therefore allows the expected state to change in time. The stationary distribution, $\boldsymbol{\delta}$, can be computed conveniently from the identity \citep{Zucchini:2009vl}

\begin{equation}
\boldsymbol\delta(\mathbf{I}_m - \boldsymbol\Gamma + \mathbf{U}) = \mathbf{1}_m
\end{equation}
%
where $\mathbf{I}_m $ is the $m\times m$ identity matrix, $\mathbf{U}$ is an $m\times m$ matrix of ones and  $\mathbf{1}_m$ is an $m$ dimension row vector of ones.

\subsection{Moments of the Gamma HM}
We provide moments and the autocorrelation function of the Gamma HM since it is not widely used. Corresponding formulas for Normal HM models are given in \cite{Akntug:2005wx} and \cite{springerlink:10.1007/978-0-387-35768-3_10}.  Let $\boldsymbol{\delta}$ denote the stationary distribution of the HM model then:

\begin{equation}
\mbox{E}(X_t) = \displaystyle\sum_{i=1}^m\frac{\delta_ik_i}{\beta_i}
\end{equation}

\begin{equation}
\mbox{Var}(X_t) = \displaystyle\sum_{i=1}^m\delta_i\left[a_i^2+\frac{k_i}{\beta_i^2}\right]
\end{equation}
%
where 
%
\begin{equation}
a_i = \frac{k_i}{\beta_i}-\mbox{E}(X_t)
\end{equation}
and
\begin{equation}
\mbox{Skew}(X_t) = \mbox{Var}(X_t)^{-3/2}\displaystyle\sum_{i=1}^m\delta_ia_i\left[a_i^2+3\left(\frac{k_i}{\beta_i^2}\right)^2\right].
\end{equation}
%
The autocorrelation function is
%
\begin{equation}
\rho(k) = \frac{\displaystyle\sum_{i=1}^m\displaystyle\sum_{j=1}^m\frac{\delta_ik_ik_j\gamma_{ij}(k)}{\beta_i\beta_j} - \left[\mbox{E}(X_t)\right]^2}{\mbox{Var}(X_t)}
\end{equation}
%
Where $\gamma_{ij}(k)$ is the $i,j$ entry of $\boldsymbol\Gamma^k$.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Parameter Estimation and Model Order Selection}

Many methods exist to estimate the parameters of HM models.  Commonly used techniques include direct maximization of the likelihood function \citep{Zucchini:2009vl,Akntug:2005wx} and Bayesian estimation procedures \citep{Thyer:2000ud,Thyer:2003kr}.  Another common method is known as the Expectation Maximization (EM) algorithm \citep{Dempster1977}.  The EM algorithm provides a good compromise between the efficiency of direct maximization and the robustness of Bayesian techniques.  The implementation of the EM algorithm in this context is know as the Baum-Welch algorithm.  This algorithm estimates the parameters of the component distributions ($\boldsymbol\Lambda$), the transition probabilities ($\boldsymbol{\Gamma}$) and the initial distribution ($\boldsymbol\delta$) simultaneously.  

Let $\boldsymbol{\theta}$ represent all the parameters to be estimated, ($\boldsymbol{\Lambda}$,$\boldsymbol{\Gamma}$,$\boldsymbol\delta$).  The EM algorithm requires initial guesses of parameters.  We found that the final parameter estimates can be somewhat sensitive to initial parameter estimates; Through experimentation we decided on the following criteria for initial guesses:

\begin{enumerate}
\item $\boldsymbol{\Gamma} = \mathbf{U}/m$, where $\mathbf{U}$ is an $m\times m$ matrix of ones. 
\item The initial parameters are estimated by fitting a single component distribution to the entire data and then the same estimates are used for all the component distributions
\item The initial distribution is first estimated as $\boldsymbol{\delta}=(1,\mathbf{0}_{m-1})$ where $\mathbf{0}_{m-1}$ is an $m-1$ dimension row vector of zeros. If the choice for $\boldsymbol{\delta}$ does not yield $m$ distinct component distributions after employing the EM algorithm, then try $\mathbf{1}_m/m$ where $\mathbf{1}_{m}$ is an $m$ dimension row vector of ones. 
\end{enumerate}

The \texttt{HiddenMarkov} package in R provides an implementation of the Baum-Welch algorithm that was used in this study \citep{Harte:2011ta}. The details of the procedure will not be discussed here but we refer the interested readers to \citep{Zucchini:2009vl}.

\subsection{Global Decoding}

Global decoding of the hidden states was done using the Viterbi algorithm \citep{Forney:1973kt}.  The Viterbi algorithm is a recursive procedure which maximizes the conditional probability

\begin{equation}
\mbox{Pr}(\mathbf{C}^{(T)} = \mathbf{c}^{(T)} | \mathbf{X}^{(T)} =\mathbf{x}^{(T)}).
\end{equation}

The resulting sequence $c_1,c_2,...,c_T$ is the most likely sequence of states, known as the global decoding. We again refer the interested readers to \citep{Zucchini:2009vl} for complete details of the procedure.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Applications of Hidden Markov Models} 

This section describes the application of HM models to Lees's Ferry natural flow data and their use for both forecasting and simulation.

\subsection{Optimal Model Order and Stationary Distributions}
Both the Bayesian Information Criteria (BIC) \citep{Schwarz:1978uv} and the Akaike Information Criteria (AIC) \citep{Akaike:1974ih} was calculated to determine the optimal model order for both normal and gamma component distributions (Table \ref{tbl:bic}).  In both cases the second order model was clearly the best in terms of both AIC and BIC. The difference between the HM2G and the HM2N is quite small so we evaluate the properties of both models.  The model parameters are shown in \ref{tbl:pars}

The stationary distributions of each model are shown in Figure \ref{fig:statdist}. Since both models have nearly identical transition probability matrices the stationary distributions are also nearly identical. The shapes of both stationary distributions is also both nearly identical which gives some confidence in the the parameter estimates.  Also of note is the nearly normal shape of both the distributions indicating that even with a nearly normally distributed data it is still possible to have underlying regimes that are very different. 

The most likely sequence of hidden states is very revealing of the underlying persistence present in the system. Figure \ref{fig:decoding} shows the global decoding and the original time series.  Also shown is the mean of the period over which the model was in a particular state. The strong tendency of the system to persist in a particular state is apparent.  We see that the states also correspond to wet and dry epochs in the data.  The period in the early 1900's corresponds the time in which the Colorado River Compact was signed which is known to be a period of above average flow. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Simulation Procedure}

Once the model is fit, simulations can be easily obtained. The procedure for simulation is:
\begin{enumerate}
\item Determine the initial state from the initial distribution, $\boldsymbol\delta$.
\item Draw a uniform random number to determine the hidden state transition from the transition probability matrix, $\boldsymbol\Gamma$.
\item Draw a random number from the component distribution corresponding to the current state. 
\item Repeat 2 and 3 for the length of the observed data set. 
\item Repeat 1--4 1200 times.
\end{enumerate}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Forecast Distributions}
Though they are not calibrated to do so, HM models can be used to conveniently produce forecast distributions for future time steps.  A forecast distribution is simply a weighted combination of the component distributions of the HM \citep{Zucchini:2009vl}

\begin{equation}
\mbox{Pr}(X_{T+h}=x | \mathbf{X}^{(T)}=\mathbf{x}^{(T)}) = \displaystyle\sum^m_{i=1}\varepsilon_i(h)p_i(x)\label{eqn:fc}
\end{equation}
Where $\varepsilon_i(h)$ is the $i$th entry of 

\begin{equation}
\boldsymbol{\alpha}_T\boldsymbol{\Gamma}^h/\boldsymbol{\alpha}_T\mathbf{1}_m^{'}
\end{equation}

The elements of $\boldsymbol{\alpha}_T$ are known as the forward probabilities and are defined as

\begin{equation}
\boldsymbol{\alpha}_T = \boldsymbol{\delta}P(x_1)\boldsymbol\Gamma P(x_2)...\boldsymbol\Gamma P(x_T) = \boldsymbol{\delta}P(x_1)\displaystyle\prod^T_{s=2}\boldsymbol\Gamma P(x_s)
\end{equation}
where $P(x_i)=diag(p_1(x_i),...,p_m(x_i))$. Using Equation \ref{eqn:fc}, forecast distributions can be generated for any $h$ future time step.

These forecast distributions are useful in the UCRB for second year forecasts where climatology is the only information available presently.  We make forecasts from April 1st when the snowpack is a good indicator of spring runoff.  We make our forecasts assuming perfect knowlege of the current year's runoff such that a single step ahead forecast is actually for the `second year'. This assumption is justified given the skill of April 1st runoff forecasts \citep{Bracken:2010cw} and the lack of sensitivity of the HM model to the addition of a single point.  In an operational setting we would simply replace the current year flow with the median April 1st forecast from the ensemble \citep{Bracken:2010cw}. 

The forecasts are verified in two ways: (1) the ranked probability skill score (RPSS) \citep{Wilks:1995p3976} is calculated for each year and (2) the correlation of the median of the forecast distributions with the observed data is calculated (refered to as the median correlation or MC). An RPSS value of 1 indicates a perfect categorical forecast, 0 indicates no different from climatology and negative values suggest worse than climatological forecast.

\subsection{Modified Forecast Procedure}

The forecast distributions are useful for assessing risk but many management models cannot input data as a PDF.  Most models require a sequence or trace of input.  Simply sampling from the forecast distributions will generate a trace but not one that maintains the persistant properties of the HM model.  With this motivation we present a forecasting procedure that can generate realistic traces:

\begin{enumerate}
\item Assume the system is in the state that has a component mean closest to the current system magnitude. 
\item Transition to a future state via the t.p.m. and the assumed state.
\item Sample from the future state distribution
\item Repeat steps 2--3 for the desired forecast length, h.
\end{enumerate}

This method simply traverses through the forecast distributions in a way that maintains the presistance in the HM model. 


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\subsection{Second Year Forecasts}
%The 24-month study is the main operational forecast model for reservoirs in the UCRB. It models nine major reservoirs on the Green, Yampa, Colorado and San Juan Rivers.  The model requires monthly input at all spatial locations. Currently forecasts are produces only for approximately the first 12 months.  The next generation of the 24-month study known as the Midterm Operations Model will be able to handle ensemble flow inputs. In both of these model in the ``out year'' climatology is used.  HM models, coupled with a disaggregation procedure \citep{Nowak:2010ha} can be used to produce ensemble forecasts in the out year.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Results}


We present the parameter estimates and results from both simulation and some examples of forecasting.  

\subsection{Simulation}

Following \cite{Guimaraes:2011tc} we generate 1200 series for each model of length 105 (the same length of the data).  Figure \ref{fig:stats} shows the boxplots of basic distributional statistics from the HM2G, HM2N and AR1 models, shown as boxplots along with observed value as horizontal line.  The basic statistics are captured very well by all the models. The HM2G model tends to slightly oversimulate the skew while HM2N tends to undersimulate it. The minimum value is captured the best by the HM2G model where the AR1 and HM2N models can simulate negative values.  This is one direct benefit of using a gamma underlying distribution. On the other hand, the HM2G slightly oversimulates the maximum which could be undesirable in some situations. Interestingly both HM models slightly as they are not designed to directly capture this .

Figure \ref{fig:density} shows the boxplot of the probability density function (PDF) of simulations from HM2G along with the observed.  This too is captured very well -- similar performance was seen from HM2N model as well (figure not shown).

The ability of HM models to simulate longer spell lengths is of interest here as it is one indicator of regime switching behavior. We have provided two views of this ability by displaying the frequency distribution and the mean counts of the spell lengths. Figure 5 shows a PDF of run lengths (in any tercile) from the HM2G simulations (shown in grey) along with the PDF of the spell length from paleo reconstructed data from \cite{Meko:2007bg}. We used this to estimate the historical distribution of run lengths as it represents a greater range of variability of the system than the observed. Another view of the run lengths is provided in Figure \ref{fig:sim-length}. The mean counts (i.e. frequency) and the cumulative mean counts are provided across all the simulations for the three models.  The cumulative mean count (and to some extent the mean count) show the increased probability of longer run lengths using either the HM2G or the HM2N models.  For example both HM models will produce a run length of 6 or greater in 8 out of 10 simulations where an AR1 model will only produce it 6 out of 10 simulations -- this translates into persistent wet and dry epochs that impact water resources system reliability.

As discussed in \cite{Kwon:2007fj}, the spectral signature is an important quantity to consider in simulation.  Figure \ref{fig:spectrum} shows the distinctly different spectral signature of the HM models compared to an AR1 model.  The HM models show much greater power in long periods, nearly the opposite signature from and AR1 model. The model is not tuned to the spectral signal of the data so we do not expect to capture the spectral peaks -- but the low frequency power that is seen in the simulations is remarkable 

\subsection{Forecasting} 
Single step ahead forecasts as described above using the modified forecast procedure did slightly better than simply using the forecast distributions, with the added benefit that these forecasts can now be used as input to traditional management models. Forecasts for the HM2G and the HM2N are shown in Figure \ref{fig:fc}.  The HM2N model is more responsive than the HM2G model to changes in the time series, producing slightly better forecasts overall.  Table \ref{tab:fc-stats} shows the forecasting statistics (RPSS and MC).  The HM2N model performs the best in all statistics, having the highest median RPSS value and median correlation (though it is not significant). The AR1 model actually does worse than climatology over 50\% of the time. The HM models both tend to do better during wet periods while the AR1 model tends to do better during dry periods.  Boxplots of the RPSS values for each year are shown in Figure \ref{fig:rpss}

Figure \ref{fig:fcdist} shows example forecasts for 1984 (wet) and 2004 (dry).  This view shows how the forecast distributions shift relative to climatology.  The HM models have the ability to simulate non-normal shapes though typically the forcast distribution is essentially zero. In practice, we found that with the Lees Ferry data, the forecast distribution converged on the stationary distribution after about 20 future time steps. 

\subsection{Three State Forecasts}
Forecasts with a two state HM model tend to perform well for dry periods but not as well for average and we periods. This is partially due to the heavy weighting on the ``dry'' component distribution. We investigated the use of a three state model for forecasting to further resolve the ``dry'' pdf. The resutls were worse overall than a two state forecast but the three state normal HM model (HM3N) tended to be more responsive in the most recent drought period (Figure \ref{fig:fc3}). 

\section{Conclusions}

We discuss the application Hidden Markov time series models to natural flow from the Upper Colorado River Basin. This data exhibits very low autocorrelation but regime shifting behavior is present that can cause long departures from the historical average flow. We suggest the low autocorrelation could be due to the shifting regimes.  We show that hidden markove models are able to capture the regime like behavior of the system while maintaining low autocorrelation.  We compare nonstationary HM models with gamma and normal component distributions.  The optimal model order based on both the BIC and AIC is 2.  The gamma (HM2G) and normal (HM2N) models have nearly identical AIC/BIC and so we examine the behavior of both compared to the more traditional AR1 model. 

In simulation mode, the HM models are able to capture all the basic statistics including the lag 1 autocorrelation.  The historical PDF is captured as well as the ditribution of run lengths.  In addition to capturing the basic statistics, HM models have 20\% greater chance than an AR1 model of simulating runs of 6 or more.  The models are able to capture shifting mean.  The ability of an HM model to capture long period regime shifting bahavor is also highlighted in the wavelet spectrum where the HM models show a much higher power than an AR1 model at longer periods.  The HM2G model may be better for simulation since it will not generate negative values.

In forecast mode, the HM models show modest skill over climatology but are able to outperform an AR1 model. The HM2N does better at forecasting than the HM2G model.  The HM models tend to do better at forecasting during wet periods as opposed to an AR1 model which does better during dry periods. 

A global decoding of both models is perhaps the most revealing result of this study. The decoding reveals and captures a strong underlying persistent structure in the Lee's Ferry time series.  Theis finding suggests that simply capturing the autocorrelation function in a simulation may not be enough to describe the system.  

The next step in in this investigation could be to relate the global decoding to some combination of atmospheric processes.  These forecasts are also currently being tested as input to a decision model for the UCRB. 


%%% End of body of article:

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Optional Appendix goes here
% 
%%%%%%%%%%%%%%%%%
% Geophysical Research Letters only allows an appendix without a letter.
%% You can get this result with
%  \section*{Appendix}
%  or
%  \section*{Appendix: Title}
%%%%%%%%%%%%%%%%%
%
% \appendix resets counters and redefines section heads
% but doesn't print anything.
% After typing  \appendix
%
% \section{Here Is Appendix Title}
% will print
% Appendix A: Here Is Appendix Title
%
% \section*{Appendix}
% will print
% Appendix
%
% \section*{Appendix: Here Is Appendix Title}
% will print
% Appendix: Here Is Appendix Title
%
% For only 1 appendix \appendix \section{Appendix} is preferred.
% which will print
% Appendix A

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Optional Glossary or Notation section, goes here
%
%%%%%%%%%%%%%%
% Glossary only allowed in Reviews of Geophysics
% \section*{Glossary}
% \paragraph{Term}
% Term Definition here
%
%%%%%%%%%%%%%%
% Notation -- End each entry with a period.
% \begin{notation}
% Term & definition.\\
% Second Term & second definition.
% \end{notation}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  ACKNOWLEDGMENTS

\begin{acknowledgments}
(Text here)
\end{acknowledgments}

%% ------------------------------------------------------------------------ %%
%
%  REFERENCE LIST AND TEXT CITATIONS
%
% Either type in your references using
% \begin{thebibliography}{}
% \bibitem{}
% Text
% \end{thebibliography}
%
% Or,
%
% If you use BiBTeX for your References, please produce your .bbl
% file and copy the contents into your paper here.
%
% Follow these steps:
% 1. Run LaTeX on your LaTeX file.
%
% 2. Run BiBTeX on your LaTeX file.
%
% 3. Open the new .bbl file containing the reference list and
%   copy all the contents into your LaTeX file here.
%
% 4. Comment out the old \bibliographystyle and \bibliography commands.
%
% 5. Run LaTeX on your new file before submitting.
%
% AGU does not want a .bib or a .bbl file, but asks that you
% copy in the contents of your .bbl file here.

\bibliographystyle{agufull08}
\bibliography{references}
%\begin{thebibliography}{}

%\bibitem[{\textit{Kilby}(2008)}]{jskilby}
%Kilby, J. S. (2008), Invention of the integrated circuit, {\it IEEE
%Trans. Electron Devices,} \textit{23}, 648--650.

%\bibitem[{\textit{Kilby et al.}(2008)}]{jskilbye}
%Kilby, J. S., S. Smith, and R. Jones (2008), Invention of the
%integrated circuit, {\it IEEE Trans. Electron Devices,} \textit{23},
%648--650.

%\end{thebibliography}

%Reference citation examples:

%...as shown by \textit{Kilby} [2008].
%...has been shown [\textit{Kilby et al.}, 2008].

%...as shown by \cite{jskilby}.
%...has been shown \citep{jskilbye}.


%% ------------------------------------------------------------------------ %%
%
%  END ARTICLE
%
%% ------------------------------------------------------------------------ %%



\end{article}

%% Enter Figures and Tables here:
\clearpage

\begin{table}
\centering
\caption{BIC and AIC for both Gamma and Normal HM models. }\label{tbl:bic}
\begin{tabular}{rcc}
\toprule
Model & BIC & AIC\\
\midrule
HM2G & 621.34 & 605.42 \\
HM3G & 647.26 & 615.42 \\
HM2N & 620.91 & 604.98 \\
HM3N & 643.73 & 611.89 \\
\bottomrule
\end{tabular}
\begin{tablenotes}

\end{tablenotes}
\end{table}


\begin{table}
\centering
\caption{BIC and AIC for both Gamma and Normal HM models. }\label{tbl:pars}
\begin{tabular}{cc}
\toprule
Parameter & Model  \\
\midrule
\multicolumn{2}{c}{HM2G}\\
\midrule
$\mathbf{k}$ & $\left[\begin{array}{c} 12.28512\\ 22.02217 \end{array}\right]$ \\ 
$\boldsymbol\beta$  & $\left[\begin{array}{c} 0.902059\\ 1.204543 \end{array}\right]$ \\ 
$\boldsymbol\Gamma$ & $\left[\begin{array}{cc} 0.98 & 0.02 \\ 0.08 & 0.92 \end{array}\right]$\\ 
$\boldsymbol\delta$ & $[0, 1]$ \\
\midrule
\multicolumn{2}{c}{HM2N}\\
\midrule
$\boldsymbol\mu$    & $\left[\begin{array}{c} 13.57519\\ 18.28946 \end{array}\right]$\\
$\boldsymbol\sigma$ & $\left[\begin{array}{c} 3.728448\\ 3.899349 \end{array}\right]$\\
$\boldsymbol\Gamma$ & $\left[\begin{array}{cc} 0.98 & 0.02 \\ 0.09 & 0.91 \end{array}\right]$\\
$\boldsymbol\delta$ & $[0, 1]$ \\
\bottomrule
\end{tabular}
\begin{tablenotes}

\end{tablenotes}
\end{table}

\begin{figure}
\centering
%\noindent\input{plots/lees-ts.tex}
\noindent\includegraphics[width=20pc]{plots/hmm-sim-figure0.pdf} 
\caption{Lees Ferry annual natural flow time series.}\label{fig:lfts}
\end{figure}

\begin{figure}
\centering
%\noindent\input{plots/statdist.tex}
\noindent\includegraphics[width=20pc]{plots/hmm-sim-figure1.pdf}
\caption{Stationary Distributions of HM2G (Top) and HM2N (Bottom).}\label{fig:statdist}
\end{figure}

%\begin{figure}
%\centering
%\noindent\input{plots/statdist3.tex}
%%\noindent\includegraphics[width=20pc]{plots/hmm-sim-figure1.pdf}
%\caption{Stationary Distributions of HM2G (Top) and HM2N (Bottom).}\label{fig:statdist}
%\end{figure}

\begin{figure}
\centering
%\noindent\input{plots/decoding-period-means.tex}
\noindent\includegraphics[width=20pc]{plots/hmm-sim-figure2.pdf}
\caption{Global Decoding of the HM2G model using the Viterbi algorithm. Plotted below is the Lees Ferry annual time series with.  The horizontal lines indicate the mean of the periods above where the model was in a particular state.}\label{fig:decoding}
\end{figure}

\begin{figure}
\centering
%\noindent\input{plots/hist-annual-gamma-stats-all.tex}
\noindent\includegraphics[width=39pc]{plots/hmm-sim-figure3.pdf}
\caption{Basic simulation statistics of HM2G, HM2N and AR1 models. Boxplots represent the spread of the simulations and the horizontal line represents the observed value.}\label{fig:stats}
\end{figure}

\begin{figure}
\centering
%\noindent\input{plots/hist-annual-gamma-hmm2-pdf.tex}
\noindent\includegraphics[width=20pc]{plots/hmm-sim-figure4.pdf}
\caption{Observed (solid line) and boxplots of simulated pdf with the HM2G model.}\label{fig:density}
\end{figure}

\begin{figure}
\centering
%\noindent\input{plots/hist-annual-gamma-sim-lengths-density.tex}
\noindent\includegraphics[width=20pc]{plots/hmm-sim-figure5.pdf}
\caption{Observed and simulated (gray region) PDF of run lengths.  The gray region extends to the 5th and 95th percentiles of the simulated PDFs.}\label{fig:sim-length}
\end{figure}

\begin{figure}
\centering
%\noindent\input{plots/hist-annual-gamma-sim-lengths-cum-mean.tex}
\noindent\includegraphics[width=20pc]{plots/hmm-sim-figure6.pdf}
\caption{Mean count (Top) and cumulative mean count (Bottom) of run lengths.  Note that these are not probabilities but rather the expected number of run lengths of a given size (or greater than a given size) in a single simulation. }\label{fig:mean-count}
\end{figure}

\begin{figure}
\centering
%\noindent\input{plots/hist-annual-gamma-spectrum.tex} 
\noindent\includegraphics[width=20pc]{plots/hmm-sim-figure7.pdf}
\caption{Quartiles of simulated HM2G and AR Global Wavelet Power Spectrum (the normal HM model is similar to the Gamma HM model).}\label{fig:spectrum}
\end{figure}

\begin{table}
\centering
\caption{Median Correlation (MC) and Median Ranked probability skill score (RPSS) of forecasts for 1980--2010.  Dry RPSS, Ave RPSS and Wet RPSS represent the median RPSS for years in the lower, middle and upper tercile respectively. }\label{tab:fc-stats}
\begin{tabular}{rccccc}
\toprule
Model & MC & RPSS & Dry RPSS & Ave RPSS & Wet RPSS\\
\midrule
HM2G & 0.31 &     0.21 & 0.26 & $-$0.11 &    0.05\\
HM2N & 0.24 &     0.17 & 0.20 &    0.11 &    0.08\\
AR1  & 0.07 &  $-$0.03 & 0.07 & $-$0.03 & $-$0.25\\
\bottomrule
\end{tabular}
\begin{tablenotes}

\end{tablenotes}
\end{table}

\begin{figure}
\centering
%\noindent\input{plots/fc-hmm2.tex}
\noindent\includegraphics[width=20pc]{plots/hmm-sim-figure8.pdf}
\caption{One step ahead forecasts from 1980 to 2010 for the HM2G (Top) and the HM2N (Bottom) with the actual data (solid line).}\label{fig:fc}
\end{figure}

\begin{figure}
\centering
%\noindent\input{plots/fc-hmm3.tex}
\noindent\includegraphics[width=20pc]{plots/hmm-sim-figure9.pdf}
\caption{One step ahead forecasts from 1980 to 2010 for the HM3G (Top) and the HM3N (Bottom) with the actual data (solid line).}\label{fig:fc3}
\end{figure}

\begin{figure}
\centering
%\noindent\input{plots/boxplot-skills.tex} 
\noindent\includegraphics[width=20pc]{plots/hmm-sim-figure10.pdf}
\caption{Boxplots of RPSS values for the forecast period 1980-2010. The horizontal line at 0 represents the skill of the climatological forecast.}\label{fig:rpss}
\end{figure}


\begin{figure}
\centering
%\noindent\input{plots/pdf-shift1984.tex} 
%\noindent\input{plots/pdf-shift2004.tex} 
\noindent\includegraphics[width=20pc]{plots/hmm-sim-figure11.pdf}
\noindent\includegraphics[width=20pc]{plots/hmm-sim-figure12.pdf}
\caption{Forecast Distributions for 1984 (Left) and 2004 (right).  The historical value is shown as a vertical line.}\label{fig:fcdist}
\end{figure}

%\begin{figure}
%\centering
%\noindent\input{plots/pdf-shift1984-3.tex} 
%\noindent\input{plots/pdf-shift2004-3.tex} 
%%\noindent\includegraphics[width=20pc]{plots/hmm-sim-figure10.pdf}
%%\noindent\includegraphics[width=20pc]{plots/hmm-sim-figure11.pdf}
%\caption{Forecast Distributions for 1984 (Left) and 2004 (right).  The historical value is shown as a vertical line.}\label{fig:fcdist}
%\end{figure}
 
% When submitting articles through the GEMS system:
% COMMENT OUT ANY COMMANDS THAT INCLUDE GRAPHICS.

% Figure captions go below this illustration; Table captions go above tables

% ONE-COLUMN figure/table, including eps graphics
%
% \begin{figure}
% %\noindent\includegraphics[width=20pc]{samplefigure.eps}
% \caption{Caption text here}
% \end{figure}
% \end{document}
%
% \begin{table}Z
% \caption{}
% \end{table}
%
% ---------------
% TWO-COLUMN figure/table
%
% \begin{figure*}
% %\noindent\includegraphics[width=39pc]{samplefigure.eps}
% \caption{Caption text here}
% \end{figure*}
%
% \begin{table*}
% \caption{Caption text here}
% \end{table*}
%
% see below for how to make landscape figures or tables


%%% End the article here:

\end{document}

